---
title: "Ecosystem Description"
output:
  word_document: default
  html_document: default
always_allow_html: true
---


```{r setup, include=FALSE, results = "asis"}
library(tidyverse)
library(rgdal)
library(sp)
library(cowplot)
library(raster)
library(knitr)
library(DT)
library(patchwork)
library(flextable)

knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)

#source('../scripts/Helper_Functions.R')
#load("../data/clean_hier_unit_datasets.RData")

```

## Habitat Complex `r unitname`
#### `r descr[count,] %>% pull(Name)`
`r descr[count,] %>% pull(Description)`

### Photos (if available)

```{r pictures, echo=FALSE, message=FALSE, warning=FALSE}
pictures <- list.files(path = "../../Images/V6", pattern = unitname, full.names = TRUE) %>% grep(pattern = "XX", value = TRUE)

show_pictures <- length(pictures)>0

```

```{r conditional_pictures, echo=FALSE, results='asis', eval=show_pictures}
for(i in seq_along(pictures)){
  path <-  pictures[i]
  cat(paste0("![Ecosystem photo](", path, ") \n\n"))
}

```


### Distribution

`r descr[count,] %>% pull(Distribution)`

Maps - Full map

```{r full map, echo=FALSE, fig.height=12, fig.width=12, message=FALSE, warning=FALSE, crop = TRUE}
 # Full map
  basemap +
    geom_tile(data=unit, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.8) +
    scale_fill_manual(values = c("#E0002D")) + scale_color_manual(values = c("#E0002D")) +
    labs(x = "x", y = "y", col = "habitat", fill = "habitat") + 
    theme(legend.position = c(0.1, 0.1), axis.text = element_blank(), axis.ticks = element_blank())
```

Regional maps

```{r inset maps, echo=FALSE, message=FALSE, warning=FALSE, crop = TRUE}
  # smaller maps
  #unit$cluster <- kmeans(unit[,c("x", "y")], centers = 10, iter.max = 100, nstart = 5)$cluster
  #units <- unit %>% filter(cluster %in% which(table(unit$cluster) > 10000)) %>% split(.$cluster)
  units <- purrr::map(acbr_ext, ~df_crop(unit, .x)) %>% 
  `[`(purrr::map_int(., nrow) %>% `>`(5000) %>% which())
  
  # remove far outliers for mapping purposes
  units <- purrr::map(units, ~if(length(c(far_outliers(.x$x), far_outliers(.x$y))) > 0) return(.x %>%    slice(-c(far_outliers(x), far_outliers(y)))) else return(.x))
  df.grids <- units %>% lapply(geo_bounds, buff = 0.1)
  ant_crops <- df.grids %>% lapply(function(x) st_crop(antarctica, x))
  bgr_unit_crops <- df.grids %>% lapply(function(x) df_crop(data, x))
  
  subplots <- map2(ant_crops, bgr_unit_crops, function(x,y){
    p <- ggplot() +  
      geom_sf(data = x, fill="gray50", color= NA, size=0.25) + coord_sf(datum = st_crs(3031)) +
      geom_tile(data = y, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) +
           theme(legend.position = "none", 
            plot.margin = unit(c(0,0,0,0), "cm"), 
            axis.text = element_blank(), 
            axis.title = element_blank()) +
      scale_y_continuous(labels = scales::scientific) + scale_x_continuous(labels = scales::scientific) 
    return(p)
  })
  
  subplots <- map2(subplots, names(units), function(x, y){
    p <- x + geom_tile(data = units[[y]], aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = .8) +
      scale_fill_manual(values = c("#E0002D")) + scale_color_manual(values = c("#E0002D")) +
      ggtitle(y) + theme(plot.title = element_text(size = 10))
    return(p)
  })
  
  subplots <- subplots %>% setNames(paste0("plot", 1:length(subplots)))
  attach(subplots)
  
  #plotcmd <- paste0("plot_grid(", paste0("plot", order(aspect), collapse = ","),", rel_widths = width)")
  plotcmd <- map_mosaic(df.grids)
 

rm(ant_crops, bgr_unit_crops)
subplots
```


```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height = nrows*8, fig.width = 12}
 eval(parse(text = plotcmd))
detach(subplots)
rm(subplots)
```


### Environment

The unit `r unitname` is part of Major Environmental Unit `r groupname`.

```{r calculate abiotic means, message=FALSE, warning=FALSE, include=FALSE}
ecodatAb$f <- "continent"
ecodatAb$f[grepl(pattern = groupname, ecodatAb$unit_h)] <- "env. unit"
ecodatAb$f[ecodatAb$unit_h == unitname] <- "habitat"
ecodatAb$f <- factor(ecodatAb$f, levels = c("continent", "env. unit", "habitat"))

abioticMeans <- ecodatAb %>% group_by(name, f) %>% 
  summarise(mean = mean(value, na.rm = T)) %>% 
  pivot_wider(names_from = "f", values_from = "mean") %>% 
  mutate(envgr_cont = ifelse(name == "meanTemp", continent/`env. unit`, `env. unit`/ continent), 
         unit_envgr = ifelse(name == "meanTemp", `env. unit`/assemblage, assemblage / `env. unit`))  
  
```

Unit `r groupname` is, on average, substantially higher in `r df2txt(abioticMeans, 1.25, type = "a")` than continental Antarctica. It is substantially lower in `r df2txt(abioticMeans, 0.75, type = "a")` than the rest of the continent.

The elevation of unit `r unitname` ranges from `r round(elev_table$min[count])` to `r round(elev_table$max[count])` metres above sea level, but 90% of its pixels fall above `r round(elev_table$lower_90[count])` and below `r round(elev_table$upper_90[count])` metres. Its average elevation is `r round(elev_table$mean[count])` metres.

The unit is higher in `r df2txt(abioticMeans, 1.25, type = "b")` and lower in `r df2txt(abioticMeans, 0.75, type = "b")` than the rest of its environmental supergroup.

#### Distinctiveness of the assemblage from its group and the rest of Antarctica

```{r abiotic boxplots, echo=FALSE, fig.height=6, fig.width=9, message=FALSE, warning=FALSE}

ggplot(ecodatAb %>% slice(sample(1:nrow(ecodatAb), 10000000)), aes(y = value, x = f, fill = f)) + 
  geom_boxplot(outlier.size = 0.2) + facet_wrap(.~name, scales = "free_y") + labs(x = "Category", fill = "Category")

```


### Biota

The most widely sampled species in the habitat complex (found in most pixels)
```{r widespreadspp, echo=FALSE, message=FALSE, warning=FALSE}
species_sorted <- rownames(PA_distinct)[PA_distinct %>% pull(count) %>% order(decreasing = TRUE)]
counts <- PA_distinct %>% pull(count) %>% sort(decreasing = TRUE)

j <- 0
n <- 0
while(n < 10){
  j <- j + 1
  n <- n + length(which(counts == unique(counts)[j]))
}

most_widespread_species <- sppDat[match(species_sorted[1:n], sppDat$scientific),] %>% dplyr::select(scientific, Functional_group, phylum) %>% data.frame(restricted = species_sorted[1:n] %in% restricted_spp, count = counts[1:n], relative_pct = round(100*counts[1:n]/sum(counts), 2)) %>% filter(relative_pct > 0) %>% 
  setNames(c("scientific name", "functional group", "phylum", "Antarctic specialist", "count", "percent of samples"))

#DT::datatable(most_widespread_species, caption = paste0("The top most widespread species in ecosystem ", unitname))

flextable(most_widespread_species) %>%
  width(width = c(1.2, 2.4, 1, 1, 0.6, 1))
```


```{r calculate biotic means, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#ecodatBi$f <- "continent"
#ecodatBi$f[grepl(pattern = groupname, ecodatBi$unit_h)] <- "env. unit"
#ecodatBi$f[ecodatBi$unit_h == unitname] <- "assemblage"

ecodatBi <- ecodatBi %>% mutate(f = ifelse(unit_h == unitname, "assemblage", 
                                           ifelse(grepl(pattern = groupname, unit_h), "env. unit", 
                                                  "continent")))
ecodatBi$f <- factor(ecodatBi$f, levels = c("continent", "env. unit", "assemblage"))


bioticMeans <- ecodatBi %>% group_by(taxon, f) %>% 
  summarise(mean = mean(value, na.rm = T)) %>% 
  pivot_wider(names_from = "f", values_from = "mean") %>% 
  mutate(envgr_cont = continent/`env. unit`, 
         unit_envgr = `env. unit`/assemblage )

```  

This supergroup is, on average, substantially higher in suitability for 
`r df2txt(bioticMeans, 1.25, "taxon", "a")` 
functional groups than continental Antarctica. It is substantially lower in suitability for
`r df2txt(bioticMeans, 0.75, "taxon", "a")` 
than the rest of the continent.

Unit `r unitname` is higher in suitability for `r df2txt(bioticMeans, 1.25, "taxon", "b")` 
and lower in suitability for `r df2txt(bioticMeans, 0.75, "taxon", "b")` than the rest of its environmental supergroup.



Distinctiveness of the unit from the environmental group and the rest of Antarctica 
 
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=9, fig.height=12}

ggplot(ecodatBi %>% slice(sample(1:nrow(ecodatBi), 10000000)), aes(y = value, x = f, fill = f)) + 
  geom_boxplot() + facet_wrap(.~taxon, scales = "free") + labs(x = "Biotic group", fill = "Biotic group") + theme(strip.text = element_text(size = 8))

```
