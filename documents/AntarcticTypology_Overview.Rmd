---
title: "Antarctic Typology Summary"
output:
  word_document: default
  html_document: default
always_allow_html: true
---

```{r setup, include=FALSE, results = "asis"}
library(tidyverse)
library(rgdal)
library(sp)
library(knitr)
library(DT)
library(ggfortify)
library(rgl)
library(viridis)
library(flextable)

#source('../scripts/Helper_Functions.R')
#load("../data/clean_hier_unit_datasets.RData")

```

### Introduction

This candidate ecosystem typology for Antarctica was created for the purposes of classifying functional ecosystem types appropriate for Red List of Ecosystem risk assessments. It focuses on permanently ice-free terrestrial areas of Antarctica and was produced at 100 m grid cell resolution. Because of the paucity of ecosystem data available for Antarctica, the classification is based primarily on Landsat-based environmental variables and secondarily on habitat suitability models for several key functional taxa. 

### Approach

The typology was created using factor analysis, which is similar to a principal components analysis, but with more flexibility allowing for unique variance in the measured variables. We aimed to preserve information about finer-scale variations in ecosystem types while accurately representing environmental conditions across the entire continent. To this end, we employed a two-step hierarchical approach (Fig. 1). First, all pixels intersecting with an ice-free area were subjected to a factor analysis incorporating ten environmental (abiotic) variables (Table S1). Second, the resulting environmental groups were each subjected to a second factor analysis separately, this time based on habitat suitability models for functional groups. The results can be used to assign each pixel a value representing how well it fits into each grouping, and each pixel is placed into the group with the best fit. 

Some pixels could not be classified due to lack of data coverage when input layers were coarse or poorly aligned. Pixels which were left unclassified by the factor analysis were therefore classified in the same biotic assemblage as their nearest classified neighbour using the arcMap function Nibble. 

The classification groups at the first tier of the analysis are termed "major environmental units", while the second tier was used to produce "habitats". During post-processing, two major environmental units representing geothermally active areas and lakes were added. 

### Results

The resulting classification scheme has 7 major environmental units, 5 from the factor analysis and 2 added later. Each of the units from the factor analysis has 4-7 subgroups determined by the suitability layers, for a total of 28 units. Three special habitats were placed in the geothermal unit: active and dormant volcanoes and geothermal areas. Lakes where represented by a single habitat due to insufficient data to classify them further. Finally, penguin colonies were added and placed in the environmental unit with the lowest elevation. The environmental units are as follows. 

```{r descriptions, echo=FALSE, message=FALSE, warning=FALSE}
env_descr <- read_csv("Environment_group_table.csv")
#DT::datatable(env_descr)
flextable(env_descr) %>% width(width = c(1, .5, 1, 4))
```

Below is a visual overview of the classification of environmental units. Each panel represents the range of values for two environmental variables in each environmental group. Cloud, melt, and precip are moisture availability variables. MeanTemp is the mean Temperature in 2014-2015. Solar is solar radiation, which is calculated based on aspect, reflected light, and other factors. Elev = elevation; rugos = Rugosity; slope = slope of incline; wind = an average measure of the amount of wind. 

```{r overview_boxplots, echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
ecodatAb %>% slice(sample(1:nrow(.), 20000000)) %>%
  separate(LCODE, into = c("group", "unit"), sep = "B") %>% 
   mutate(unit = ifelse(group %in% c("G1", "G2", "G3", "L"), group, unit), 
          group = ifelse(group %in% c("G1", "G2", "G3", "L"), "G and L", group)) %>%
  ggplot( aes(x = group, y = value, fill = group)) + geom_boxplot(outlier.size = 0.2) + 
  facet_wrap(~name, scales = "free_y") + 
  labs(fill = "Environmental unit", x = "Environmental unit")

```

To help further contextualize the environmental conditions in each unit, 50% confidence ellipses are plotted for each unit around a selection of variables below:

Terrain

```{r terrain, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
col12 <- c(gg_color_hue(7), "sienna1", "purple", "slateblue", "pink1", "steelblue1")

ellipse_data <- data %>% 
  separate(LCODE, into = c("unit", "habitat"), sep = "B") %>% 
   mutate(habitat = ifelse(unit %in% c("G1", "G2", "G3", "L"), unit, habitat), 
          unit = ifelse(unit %in% c("G1", "G2", "G3", "L"), "G and L", unit))
  
ggplot(ellipse_data, aes(x = slope, y = elevation, color = habitat)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~unit, scales = 'fixed') +
  scale_color_manual(values = col12) + labs(color = "habitat")

```

Moisture availability (note logged axes)

```{r moisture, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}

ggplot(ellipse_data, aes(x = melt, y = totPrecip, color = habitat)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~unit, scales = 'fixed') +
  scale_y_log10() + scale_x_log10() +
  scale_color_manual(values = col12)

```

Wind and light conditions

```{r wind, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
ggplot(ellipse_data, aes(x = solar, y = wind, color = habitat)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~unit, scales = 'fixed') + 
  scale_color_manual(values = col12)

```

Cloud and growing season 

```{r cloud, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
ggplot(ellipse_data, aes(x = cloud, y = DDm5, color = habitat)) + 
       stat_ellipse(level = 0.50, lwd = 1.5)+ 
       facet_wrap(.~unit, scales = 'fixed') + scale_y_log10() +
       scale_color_manual(values = col12)

```

Below are more detailed visual overviews of the variable range in each unit, plotted separately for each environmental group. These plots should help give a clearer idea of how the units are distinct from one another. Note that unit-level classification was done on suitability data alone, meaning that the environmental differences among units are likely reflected by differing biotas, even if they are slight. 

### Environmental unit 1 (Mild Lowlands) 


```{r E1map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(13:19, 400))

# Full map
  ggplot() +
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```

```{r E1box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("E1", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("E1", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```

### Environmental unit 2 (Midland humid habitats) 

```{r E2map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(1:4)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r E2box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("E2", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("E2", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```



### Environmental unit 3 (Midland dry/sunny habitats)

```{r E3map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(21:25))

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_manual(values = c(viridis(7), "red")) + 
    scale_color_manual(values = c(viridis(7), "red")) + labs(x = "x", y = "y") 
    
```


```{r E3box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("E3", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("E3", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```


### Environmental unit 4 (High mountaintops) 

```{r E4map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(6:11)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) +   
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) +labs(x = "x", y = "y")
```


```{r E4box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("E4", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("E4", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```


### Environmental unit 5 (High flatlands) 

```{r E5map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(27:32)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r E5box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("E5", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("E5", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```


### Geothermal Areas and Lakes 

```{r GLmap, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- typ_df %>% dplyr::filter(typv6_v1pl %in% c(100, 200, 300, 500)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = typ_df, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = 0.7) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r GLbox, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
ecodatAb %>% filter(grepl("G|L", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

ecodatBi %>% filter(grepl("G|L", LCODE)) %>% 
  ggplot(aes(x = LCODE, y = value, fill = LCODE)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~taxon,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```



