---
title: "Antarctic Typology Summary"
author: "Aniko B Toth"
date: "17/09/2021"
output:
  word_document: default
  html_document: default
always_allow_html: true
---

```{r setup, include=FALSE, results = "asis"}
library(tidyverse)
library(rgdal)
library(sp)
library(knitr)
library(DT)
library(ggfortify)
library(rgl)
library(viridis)
library(flextable)

#source('../scripts/Helper_Functions.R')
#load("../data/clean_hier_unit_datasets.RData")

```

### Introduction

This candidate ecosystem typology for Antarctica was created for the purposes of classifying functional ecosystem types appropriate for Red List of Ecosystem risk assessments. It focuses on permanently ice-free terrestrial areas of Antarctica and was produced at 100 m grid cell resolution. Because of the paucity of ecosystem data available for Antarctica, the classification is based primarily on Landsat-based environmental variables and secondarily on habitat suitability models for several key functional taxa. 

### Approach

The typology was created using factor analysis, which is similar to a principal components analysis, but with more flexibility allowing for unique variance in the measured variables. Factor analysis looks for latent variables that account for shared variance among the measured variables. This approach was chosen because it is very straightforward and deterministic. While many more sophisticated clustering algorithms exist, most require some form of randomisation meaning that the results will be different (often significantly) between different runs. This is particularly true for Antarctic data, which does not exibit any clear-cut groupings. Furthermore, because Antarctica is understudied and its overall biogeography has received minimal attention, very little data exists that could be used to validate any clustering scheme, making it nearly impossible to choose a "best" solution from among candidate typologies that use randomisation. 

One goal was to preserve information about finer-scale variations in ecosystem types while accurately representing environmental conditions across the entire continent. To this end, we employed a two-step hierarchical approach (Fig. 1). First, all pixels intersecting with an ice-free area were subjected to a factor analysis incorporating ten environmental (abiotic) variables (Table S1). Second, the resulting environmental groups were each subjected to a second factor analysis separately, this time based on suitability maps for functional groups. The results can be used to assign each pixel a value representing how well it fits into each grouping, and each pixel is placed into the group with the best fit. 

Some pixels could not be classified due to lack of data coverage when input layers were coarse or poorly aligned. Pixels which were left unclassified by the factor analysis were therefore classified in the same biotic assemblage as their nearest classified neighbour using the arcMap function Nibble. 


### Results

The resulting classification scheme has 5 major environmental units. Each unit has 4-7 subgroups determined by the suitability layers, for a total of 28 units. Five special ecosystems that were not represented by the biotic and abiotic data layers were overlaid on the typology: active and dormant volanoes, geothermal areas, lakes, and penguin rookeries. The environmental groups are as follows. 

```{r descriptions, echo=FALSE, message=FALSE, warning=FALSE}
env_descr <- read_csv("Environment_group_table.csv")
#DT::datatable(env_descr)
flextable(env_descr) %>% width(width = c(1, .5, 1, 4))
```

Below is a visual overview of the classification of environmental groups. Each panel represents the range of values for one environmental variable in each environmental group. Cloud, melt, and precip are moisture availability variables. meanTemp is the mean Temperature in 2014-2015. Solar is solar radiation, which is calculated based on aspect, reflected light, and other factors. Elev = elevation; rugos = Rugosity; slope = slope of incline; wind = an average measure of the amount of wind. 



```{r overview_boxplots, echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}
data[sample(1:nrow(data), size = 400000),] %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% 
  separate(unit_h, into = c("group", "unit"), sep = "B") %>% 
   mutate(unit = ifelse(group %in% c("G1", "G2", "G3", "L"), group, unit), 
          group = ifelse(group %in% c("G1", "G2", "G3", "L"), "G and L", group)) %>%
  pivot_longer(all_of(abiotic)) %>% 
  ggplot( aes(x = group, y = value, fill = group)) + geom_boxplot(outlier.size = 0.2) + 
  facet_wrap(~name, scales = "free_y") + 
  labs(fill = "Environmental group", x = "Environmental Group")

```

To help further contextualize the environmental conditions in each unit, 50% confidence ellipses are plotted for each unit around a selection of variables below:

Terrain

```{r terrain, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
col12 <- c(gg_color_hue(7), "sienna1", "purple", "slateblue", "pink1", "steelblue1")

ellipse_data <- data %>% #filter(!grepl("NA", unit_h, fixed = TRUE)) %>% 
  separate(unit_h, into = c("group", "unit"), sep = "B") %>% 
   mutate(unit = ifelse(group %in% c("G1", "G2", "G3", "L"), group, unit), 
          group = ifelse(group %in% c("G1", "G2", "G3", "L"), "G and L", group))
  
ggplot(ellipse_data, aes(x = slope, y = elevation, color = unit)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~group, scales = 'fixed') +
  scale_color_manual(values = col12)

```

Moisture availability (note logged axes)

```{r moisture, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}

ggplot(ellipse_data, aes(x = melt, y = totPrecip, color = unit)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~group, scales = 'fixed') +
  scale_y_log10() + scale_x_log10() +
  scale_color_manual(values = col12)

```

Wind and light conditions

```{r wind, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
ggplot(ellipse_data, aes(x = solar, y = wind, color = unit)) + 
  stat_ellipse(level = 0.50, lwd = 1.5) + 
  facet_wrap(.~group, scales = 'fixed') + 
  scale_color_manual(values = col12)

```

Cloud and growing season 

```{r cloud, echo=FALSE, fig.height=7, fig.width=9, message=FALSE, warning=FALSE}
ggplot(ellipse_data, aes(x = cloud, y = DDm5, color = unit)) + 
       stat_ellipse(level = 0.50, lwd = 1.5)+ 
       facet_wrap(.~group, scales = 'fixed') + scale_y_log10() +
       scale_color_manual(values = col12)

```

Below are more detailed visual overviews of the variable range in each unit, plotted separately for each environmental group. These plots should help give a clearer idea of how the units are distinct from one another. Note that unit-level classification was done on suitability data alone, meaning that the environmental differences among units are likely reflected by differing biotas, even if they are slight. 

### Environmental group 1 (Midland mesic ecosystems) variables by unit.


```{r E1map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(1:4))

# Full map
  ggplot() +
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```

```{r E1box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("E1", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
# data %>% filter(grepl("E1", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```

### Environmental group 2 (Rugged high mountain slopes) variables by unit

```{r E2map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(6:11)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r E2box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("E2", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,    scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
#data %>% filter(grepl("E2", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```



### Environmental group 3 (Mild lowlands) variables by unit

```{r E3map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(13:19, 400))

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_manual(values = c(viridis(7), "red")) + 
    scale_color_manual(values = c(viridis(7), "red")) + labs(x = "x", y = "y") 
    
```


```{r E3box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("E3", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,   scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
#data %>% filter(grepl("E3", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```


### Environmental group 4 (Sunny slopes) variables by unit

```{r E4map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(21:25)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) +   
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) +labs(x = "x", y = "y")
```


```{r E4box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("E4", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,   scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
#data %>% filter(grepl("E4", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())


```


### Environmental group 5 (Highland windy plateaus) variables by unit

```{r E5map, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(27:32)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r E5box, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("E5", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,   scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
#data %>% filter(grepl("E5", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```


### Geothermal Areas and Lakes 

```{r GLmap, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
group <- data %>% dplyr::filter(typv6_v1pl %in% c(100, 200, 300, 500)) 

# Full map
  ggplot() +  
    geom_sf(data=antarctica, fill="gray50", color= NA, size=0.25) + 
    coord_sf(datum = st_crs(3031)) +
    geom_tile(data = data, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) + 
    geom_tile(data = group, aes(x=x, y=y, col= unit_h, fill = unit_h), lwd = 1.1) +
    scale_fill_viridis(discrete = TRUE) + scale_color_viridis(discrete = TRUE) + labs(x = "x", y = "y")
```


```{r GLbox, echo=FALSE, message=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data %>% filter(grepl("G|L", unit_h), !grepl("NA", unit_h)) %>% 
  dplyr::select(unit_h, all_of(abiotic)) %>% pivot_longer(all_of(abiotic)) %>% 
  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name,   scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())
#data %>% filter(grepl("G|L", unit_h), !grepl("NA", unit_h)) %>% 
#  dplyr::select(unit_h, all_of(good_models)) %>% pivot_longer(all_of(good_models)) %>% 
#  ggplot(aes(x = unit_h, y = value, fill = unit_h)) + geom_boxplot(outlier.size = 0.3) + facet_wrap(~name, #  scales = "free") + scale_fill_viridis(discrete = TRUE) + theme(axis.text.x = element_blank())

```



