---
title: "Ecosystem Description"
author: "Aniko B. Toth"
output: html_document
---


```{r setup, include=FALSE, results = "asis"}
library(tidyverse)
library(rgdal)
library(sp)
library(cowplot)
library(raster)
library(knitr)
library(DT)

#source('../scripts/Helper_Functions.R')
#load("../data/clean_hier_unit_datasets.RData")

```

## Ecosystem `r unitname`

### Distribution

Verbal Description??

Maps - Full map

```{r echo = FALSE, message = FALSE, warning = FALSE}
 # Full map
  ggplot() +  
    geom_polygon(data=antarctica, aes(x=long, y=lat, group=group), 
                 fill="gray50", color= NA, size=0.25) +
    geom_tile(data=unit, aes(x=x, y=y, col= ecosystem, fill = ecosystem), lwd = 1.5) +
    scale_fill_manual(values = c("#E0002D")) + scale_color_manual(values = c("#E0002D")) +
    coord_equal()
```

Smaller maps

```{r echo=FALSE, fig.width=8, message=FALSE, warning=FALSE}
  # smaller maps
  unit$cluster <- dist(unit[,c("x", "y")], method = 'euclidean') %>% hclust(method = 'average') %>% cutree(k = 6)
  units <- unit %>% filter(cluster %in% which(table(unit$cluster) > 100)) %>% split(.$cluster)
  df.grids <- units %>% lapply(geo_bounds, buff = 0.15)
  aspect <- units %>% sapply(aspect_ratio)
  ant_crops <- df.grids %>% lapply(function(x) crop(antarctica, extent(x)))
  
  subplots <- map2(ant_crops, units, function(x,y){
    p <- ggplot() +  
      geom_polygon(data = x, aes(x=long, y=lat, group=group), fill="gray50", color= NA, size=0.25) +
      geom_tile(data = y, aes(x=x, y=y, col= ecosystem, fill = ecosystem), lwd = .8) +
      scale_fill_manual(values = c("#E0002D")) + scale_color_manual(values = c("#E0002D")) +
      coord_equal() + theme(legend.position = "none", plot.margin = unit(c(0,0,0,0), "cm")) +
      scale_y_continuous(labels = scales::scientific) + scale_x_continuous(labels = scales::scientific)
    return(p)
  })
  
  subplots <- subplots %>% setNames(paste0("plot", 1:length(subplots)))
  attach(subplots)
  plotcmd <- paste0("plot_grid(", paste0("plot", 1:length(subplots), collapse = ","),", rel_widths = aspect)")
  eval(parse(text = plotcmd))

```


### Environment

The unit `r unitname` is part of the environmental supergroup `r word(unitname, 1,1, "_")`.

```{r message=FALSE, warning=FALSE, include=FALSE}
 unit_cont <- ecodat %>% filter(variable %in% abiotic) %>% group_by(variable) %>% summarise(relative = t.test(value[unit_h == unitname], value[unit_h != unitname])$estimate[1] - t.test(value[unit_h == unitname], value[unit_h != unitname])$estimate[2], p = t.test(value[unit_h == unitname], value[unit_h != unitname])$p.value) %>% arrange(desc(relative))

 envgr_cont <- ecodat %>% filter(variable %in% abiotic) %>% group_by(variable) %>% summarise(relative = t.test(value[grepl(pattern = word(unitname, 1,1, "_"), unit_h)], value[!grepl(pattern = word(unitname, 1,1, "_"), unit_h)])$estimate[1] - t.test(value[grepl(pattern = word(unitname, 1,1, "_"), unit_h)], value[!grepl(pattern = word(unitname, 1,1, "_"), unit_h)])$estimate[2], p = t.test(value[grepl(pattern = word(unitname, 1,1, "_"), unit_h)], value[!grepl(pattern = word(unitname, 1,1, "_"), unit_h)])$p.value) %>% arrange(desc(relative))
 
  unit_envgr <- ecodat %>% filter(variable %in% abiotic & grepl(pattern = word(unitname, 1,1, "_"), unit_h)) %>% group_by(variable) %>% summarise(relative = t.test(value[unit_h == unitname], value[unit_h != unitname])$estimate[1] - t.test(value[unit_h == unitname], value[unit_h != unitname])$estimate[2], p = t.test(value[unit_h == unitname], value[unit_h != unitname])$p.value) %>% arrange(desc(relative))

  
```
This supergroup has, on average, substantially higher `r envgr_cont[envgr_cont$relative > 0.05, "variable"] %>% unlist() %>% as.character()` than continental antarctica. It also has substantially lower `r envgr_cont[envgr_cont$relative < -0.05, "variable"] %>% unlist() %>% as.character()` than the rest of the continent.

Unit `r unitname` has higher `r unit_envgr[unit_envgr$relative > 0.04, "variable"] %>% unlist() %>% as.character()` and lower `r unit_envgr[unit_envgr$relative < -0.04, "variable"] %>% unlist() %>% as.character()` than the rest of its environmental supergroup.


Range of environmental variables present in the unit:

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% abiotic & unit_h == unitname), aes(x = variable, fill = variable, y = value)) + geom_boxplot()

```



Distinctiveness of environmental group from rest of Antarctica.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% abiotic), aes(y = value, x = grepl(pattern = word(unitname, 1,1, "_"), unit_h), fill = grepl(pattern = word(unitname, 1,1, "_"), unit_h))) + 
  geom_boxplot() + facet_wrap(.~variable) + labs(x = "Abiotic group", fill = "Abiotic group")

DT::datatable(envgr_cont)
```

Distinctiveness of unit `r unitname` from rest of environmental group

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% abiotic & grepl(pattern = word(unitname, 1,1, "_"), unit_h)), aes(y = value, x = unit_h == unitname, fill = unit_h == unitname)) + 
  geom_boxplot() + facet_wrap(.~variable) 

DT::datatable(unit_envgr)
```



Distinctiveness of unit `r unitname` from rest of antarctica.
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% abiotic), aes(y = value, x = unit_h == unitname, fill =  unit_h == unitname)) + 
  geom_boxplot() + facet_wrap(.~variable)
DT::datatable(unit_cont)
```




### Biota

Top 10 most commonly sampled species in the unit
```{r echo = FALSE, message = FALSE, warning = FALSE, results = "asis"}
species_sorted <- rownames(PA)[PA %>% pull(count) %>% order(decreasing = TRUE)]
counts <- PA %>% pull(count) %>% sort(decreasing = TRUE)

i <- 0
n <- 0
while(n < 10){
  i <- i + 1
  n <- n + length(which(counts == unique(counts)[i]))
}

most_sampled_species <- sppDat[match(species_sorted[1:n], sppDat$scientific),] %>% dplyr::select(scientific, Functional_group, phylum) %>% data.frame(restricted = species_sorted[1:n] %in% restricted_spp, count = counts[1:n], relative_pct = round(100*counts[1:n]/sum(counts), 4)) %>% filter(relative_pct > 0)

DT::datatable(most_sampled_species, caption = paste0("The top most sampled species in ecosystem ", unitname))
```


Any well-sampled species that occur MOST commonly in the unit
```{r echo=FALSE, message=FALSE, warning=FALSE}
commons <- commonspp[which(commonspp == count)] %>% names()

common_table <- sppDat[match(commons, sppDat$scientific),] %>% dplyr::select(scientific, Functional_group, phylum) %>% data.frame(restricted = commons %in% restricted_spp, relative_pct = dom_pct[commons]) %>% filter(relative_pct > 0) %>% tibble()
if(nrow(common_table)>0){DT::datatable(common_table, caption = paste0("A list of common species whose highest incidence of sampling is in ", unitname))
  }else cat("None \n")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
sampled_species <- rownames(PA)[PA %>%  pull(count) %>% `>`(0) %>% which()]
singl <- sampled_species[sampled_species %in% singletons]
singl_table <- sppDat[match(singl, sppDat$scientific),] %>% dplyr::select(scientific, Functional_group, phylum) %>% data.frame(restricted = singl %in% restricted_spp) 
if(nrow(singl_table) > 0){
  DT::datatable(singl_table, caption = paste0("A list of singletons (only one sampled individual) that are found in ", unitname))
} else cat("None \n")

```

A list of doubletons (two sampled individuals) found in the unit

```{r echo=FALSE, message=FALSE, warning=FALSE}

doubl <- sampled_species[sampled_species %in% doubletons]
doubl_table <- sppDat[match(doubl, sppDat$scientific),] %>% dplyr::select(scientific, Functional_group, phylum) %>% data.frame(restricted = doubl %in% restricted_spp) 
if(nrow(doubl_table) > 0){
  DT::datatable(doubl_table, caption = paste0("A list of doubletons (two sampled individuals) that are found in ", unitname))
} else cat("None \n")

```

Suitability for functional groups?

```{r echo=FALSE, fig.height=10, fig.width=5, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% good_models & unit_h == unitname), aes(x = variable, fill = variable, y = value)) + geom_boxplot() + theme(legend.position = "none", axis.text.x = element_text(angle = 90)) 
```

Distinctiveness from rest of antarctica.

```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
ggplot(ecodat %>% filter(variable %in% good_models), aes(y = value, x = unit_h == unitname, fill =  unit_h == unitname)) + 
  geom_boxplot() + facet_wrap(.~variable)

```



### Literature 

List of papers potentially relevant to the unit