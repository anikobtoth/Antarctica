---
title: "Appendix S3: Bioregional Ecosystem Types"
author: "Aniko B Toth"
date: "25/08/2023"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
#source("../scripts/Helper_Functions.R")
library(dplyr)
library(ggplot2)
library(sf)
```

Bioregional Ecosystem Types (BETs) are necessary for a more local view of the Antarctic ice-free typology. This level of organisation is useful for performing targeted IUCN risk assessments. 

BETs were generated by intersecting the first two tiers of the typology with the Antarctic Conservation Bioregions (ACBRs; see Fig. 1). This resulted in 369 candidate units, some with as few as a single pixel. There were 29 unique BETs comprised of geothermal areas, lakes, and penguin colonies, and these were excluded from the processing to follow, leaving 340 regular candidate units. BETs with tiny areas are unlikely to be regarded as unique ecosystems locally if similar ecosystems are found in close proximity. Therefore, these units were subjected to a lumping process according to the logic tree below.  

![Logic Tree](Regional_logicTree.png)
Figure S3-1. Decision process for lumping candidate bioregional units into the final BETs. At least 5% of pixels in the candidate unit in question need to be next to a pixel of another unit to be considered “adjacent”. 

Application of the logic tree resulted in 190 BETs. Of these, 123 are a single habitat complex-ACBR combination, and 67 consist of two or more lumped candidate units. 48 additional candidate units were not lumped with any others due to small area and no possibility of merging (no adjacent cells from same Major Environmental Unit). Counting overlay ecosystems and all lumped or single units, this process resulted in 309 BETs.

Below are maps of all BETs with 10 or more pixels in our output. Many lumped BETs are made up of a small unit lumped into a larger one which is more prevalent in the area. Others are made up of several small candidate units in the same Major Environmental Unit. It is worth noting that no BETs ended up being lumped across Bioregional borders. Many single and several lumped BETs contained fewer than 1000 pixels. We flag these for follow up in future field studies. More direct observations will likely be needed to establish whether tiny, isolated BETs are unique ecosystems with distinct biota. 


```{r proposed_merges, echo=FALSE, fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}

geo_bounds <- function(df, buff = 0.1){
  bufferx <- diff(range(df$x))*buff
  buffery <- diff(range(df$y))*buff
  ext <- c(xmin = min(df$x) - bufferx, 
           xmax = max(df$x) + bufferx,
           ymin = min(df$y) - buffery,
           ymax = max(df$y) + buffery)
  return(ext)
}

df_crop <- function(df, ext, buff = 5){
  df %>% filter(x >= ext["xmin"]-buff, 
                x <= ext["xmax"] + buff, 
                y >= ext["ymin"] - buff, 
                y <= ext["ymax"]+ buff) %>% 
    return()
}

antarctica <- st_read("../data/Base", "Coastline_high_res_polygon_v7.1", quiet = T) %>% st_simplify()
ru <- readRDS("../results/RegionalUnitsV6_3.rds")
ru$x <- st_coordinates(ru)[,"X"]
ru$y <- st_coordinates(ru)[,"Y"]

for(acbr in unique(ru$ACBR_Name)){
  ru1 <- ru %>% filter(ACBR_Name == acbr)
  
  for(i in unique(ru1$final)){
  curr.ru <- ru1 %>% filter(final == i)
  n <- nrow(curr.ru)
  
  if(n > 10){ ## skip the really tiny ecosystems (< 10 pixels)
    m <- length(unique(curr.ru$ru))
  ext <- geo_bounds(curr.ru)
  bg <- df_crop(ru1, ext, 5)
  bgpoly <- st_crop(antarctica, ext)


  p <- ggplot() +  
    geom_sf(data = bgpoly, fill="gray50", color= NA, size=0.25) +
    geom_tile(data = bg, aes(x = x, y = y), fill = "gray35", col = "gray35", lwd = 0.8) +
    geom_tile(data = curr.ru, aes(x=x, y=y, col= LCODE, fill = LCODE), lwd = .8) +
    theme(plot.margin = unit(c(0,0,0,0), "cm"), 
          axis.text = element_blank(), 
          axis.title = element_blank()) +
    labs(col = "Habitat", fill = "Habitat") +
    ggtitle(ru1$ACBR_Name[1],
      subtitle = paste("BET", i, "with", n, "pixels"))+
    scale_y_continuous(labels = scales::scientific) + scale_x_continuous(labels = scales::scientific) 
  
  print(p)
  }
  
  
 }
}


```

